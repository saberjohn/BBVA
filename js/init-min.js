function removeLayers(e){e=e==false?e:true;$(".loading").show();polygonsGroup.clearLayers();polygonsCustGroup.clearLayers();polylinesGroup.clearLayers();polylinesGroup2.clearLayers()}function printResults(e){function u(e,t){var n=" - ";for(var r=0;r<t.length;r++){if(t[r].indexOf(n)!=-1){var i=t[r].split(n);if(e<=parseFloat(i[1])){return r}}else{if(e==t[r]){return r}}}}function f(e,t){t.on("click",function(t){rightSidebar.hide();map.removeLayer(sMarker);sMarker=L.marker([t.latlng.lat,t.latlng.lng],{ZipCode:e.properties.ZipCode}).addTo(map);sMarker.bindPopup("Código postal: "+e.properties.ZipCode);getBasicStats(e.properties.ZipCode);sMarker.on("click",function(){leftSidebar.show();rightSidebar.hide()})})}polygonsGroup.clearLayers();var t=map._zoom;var n=[];jQuery.each(e.features,function(e,t){n.push(t.properties[propertySelected])});var r=new geostats;r.setSerie(n);var i=new Array("#FFD4C4","#FF8069","#E84E3D","#E63629");var s=r.getClassJenks(4);var o=r.ranges;r.setColors(i);$(".serie1").html(o[0]);$(".serie2").html(o[1]);$(".serie3").html(o[2]);$(".serie4").html(o[3]);var a=L.geoJson(e,{onEachFeature:f,style:function(e){return{fillOpacity:.6,opacity:.7,weight:1.2,color:"#fff",fillColor:i[u(e.properties[propertySelected],o)]}}});polygonsGroup.addLayer(a);polygonsGroup.addTo(map);$(".number-2").number(true,0)}function getZipcodeFromPoint(e){if(e==undefined){return false}else{var t=new L.LatLng(e.lat,e.lng)}var n=leafletPip.pointInLayer(t,L.geoJson(dataGeoJson),true);if(n.length){return n[0].feature.properties.ZipCode}else{return false}}function getBasicStats(e,t){$(".zipcode").text(e);markersCustZC.clearLayers();polylinesGroup.clearLayers();if(datazipcode[e]==undefined){if(e&&e!=undefined){$(".loading").show();$("#banner-slide").hide();$.ajax({cache:false,type:"POST",url:baseurl+"/basic-stats/"+e+"/",success:function(t){datazipcode[e]=t;getSeries(t);$(".loading").hide()},error:function(e){$(".loading").hide()}})}}else{getSeries(datazipcode[e])}var n=false;L.geoJson(dataGeoJson,{filter:function(t,r){if(e==t.properties.ZipCode)n=t.properties;return false}});var r=$("#listdata");r.html("");$.each(poblacion,function(e,t){if(n[e]!=undefined){r.append($("<li></li>").html(t+":"+" <span class='number-2'>"+n[e]+"</span>"))}});var i=$("#listdata2");i.html("");$.each(vivienda,function(e,t){if(n[e]!=undefined){i.append($("<li></li>").html(t+":"+" <span class='number-2'>"+n[e]+"</span>"))}});var s=$("#listdata3");s.html("");$.each(economico,function(e,t){if(n[e]!=undefined){s.append($("<li></li>").html(t+":"+" <span class='number-2'>"+n[e]+"</span>"))}});var o=$("#listdata4");o.html("");$.each(educacion,function(e,t){if(n[e]!=undefined){o.append($("<li></li>").html(t+":"+" <span class='number-2'>"+n[e]+"</span>"))}});var u=$("#listdata5");u.html("");$.each(conyugal,function(e,t){if(n[e]!=undefined){u.append($("<li></li>").html(t+":"+" <span class='number-2'>"+n[e]+"</span>"))}});var a=$("#listdata6");a.html("");$.each(unidadeseconomicas,function(e,t){if(n[e]!=undefined){a.append($("<li></li>").html(t+":"+" <span class='number-2'>"+n[e]+"</span>"))}});$(".number-2").number(true,0);map.setView([sMarker._latlng.lat,sMarker._latlng.lng,map._zoom])}function getSeries(e){$(".no-graphic").hide();$(".tipo-serie-grafica").hide();$("#banner-slide ul li").remove();$("#banner-slide .bjqs-markers").remove();$("#banner-slide .bjqs-controls").remove();var t=$("#graph-type option:selected").val();if(e.day==undefined||e.day==false){var n=false}else{var n=[];jQuery.each(e.day.stats,function(e,r){if(r[t]==undefined){n.push(0)}else{n.push(r[t])}})}var r=false;if(e.gender_distribution==undefined||e.gender_distribution==false){r=false}else{r={male:[],female:[]};jQuery.each(e.gender_distribution.stats,function(e,n){if(n.histogram.length==0){r.male.push(0);r.female.push(0)}else{if(n.histogram[0][t]==undefined){r.male.push(0);r.female.push(0)}else if(n.histogram.length==1){if(n.histogram[0].gender=="M"){r.male.push(0);r.female.push(n.histogram[0][t])}else{r.female.push(0);r.male.push(n.histogram[0][t])}}else if(n.histogram.length==2){if(n.histogram[0].gender=="M"){r.female.push(n.histogram[0][t])}else{r.male.push(n.histogram[0][t])}if(n.histogram[1].gender=="M"){r.female.push(n.histogram[1][t])}else{r.male.push(n.histogram[1][t])}}}})}if(r==false&&n==false){}else{getTimeSeriesChart(n,r)}if(e.age_distribution==undefined||e.age_distribution==false){var i=false}else{if(t=="num_cards")t="num_payments";var i={a1925:[],a2635:[],a3645:[],a4655:[],a5665:[],am66:[]};jQuery.each(e.age_distribution.stats,function(e,n){va1925=0;va2635=0;va3645=0;va4655=0;va5665=0;vam66=0;jQuery.each(n.histogram,function(e,n){if(n.ages=="19-25"){va1925=n[t]}else if(n.ages=="26-35"){va2635=n[t]}else if(n.ages=="36-45"){va3645=n[t]}else if(n.ages=="46-55"){va4655=n[t]}else if(n.ages=="56-65"){va5665=n[t]}else if(n.ages==">=66"){vam66=n[t]}});i.a1925.push(va1925);i.a2635.push(va2635);i.a3645.push(va3645);i.a4655.push(va4655);i.a5665.push(va5665);i.am66.push(vam66)});getChartAgeDistribution(i)}if(e.customer_zipcodes.zcs!=null){setMarkers(e.customer_zipcodes,sMarker.options.ZipCode)}else{markersCustZC.clearLayers();polylinesGroup.clearLayers()}$("#banner-slide").bjqs({height:400,width:500,automatic:false});if(r==false&&n==false&&i==false){$(".no-graphic").show();$(".tipo-serie-grafica").hide()}else{$(".tipo-serie-grafica").show()}leftSidebar.show()}function getChartAgeDistribution(e){var t=$("#graph-type option:selected").val();if(t=="avg")var n="Promedio de pago";if(t=="num_payments")var n="Número de pagos";if(t=="num_cards")var n="Número de pagos";$("#banner-slide ul").append('<li><div id="points-graph-age" style="min-width: 500px; height: 400px; margin: 0 auto"></div></li>');var r=$("#points-graph-age").highcharts({chart:{zoomType:"x"},title:{text:"Rango de edades"},subtitle:{text:document.ontouchstart===undefined?"Clic y arrastrar para hacer zoom":"Clic para hacer zoom"},xAxis:{type:"datetime",minRange:14*24*36e5},yAxis:{title:{text:n},minRange:.1,min:0},legend:{enabled:true},plotOptions:{area:{fillColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,Highcharts.getOptions().colors[0]],[1,Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get("rgba")]]},marker:{radius:2},lineWidth:1,states:{hover:{lineWidth:1}},threshold:null}},series:[{name:"19-25",pointInterval:24*3600*1e3,pointStart:Date.UTC(2013,10,1),data:e.a1925},{name:"26-35",pointInterval:24*3600*1e3,pointStart:Date.UTC(2013,10,1),data:e.a2635},{name:"36-45",pointInterval:24*3600*1e3,pointStart:Date.UTC(2013,10,1),data:e.a3645},{name:"46-55",pointInterval:24*3600*1e3,pointStart:Date.UTC(2013,10,1),data:e.a4655},{name:"56-65",pointInterval:24*3600*1e3,pointStart:Date.UTC(2013,10,1),data:e.a5665},{name:">=66",pointInterval:24*3600*1e3,pointStart:Date.UTC(2013,10,1),data:e.am66}]});$("#banner-slide").show();$("#points-graph-age").show()}function getTimeSeriesChart(e,t){var n=$("#graph-type option:selected").val();if(n=="avg")var r="Promedio de pago";if(n=="num_payments")var r="Número de pagos";if(n=="num_cards")var r="Número de tarjetas";$("#banner-slide ul").append('<li><div id="points-graph" style="min-width: 500px; height: 400px; margin: 0 auto"></div></li>');var i=$("#points-graph").highcharts({chart:{zoomType:"x"},title:{text:"Total y Generos"},subtitle:{text:document.ontouchstart===undefined?"Clic y arrastrar para hacer zoom":"Clic para hacer zoom"},xAxis:{type:"datetime",minRange:14*24*36e5},yAxis:{title:{text:r},minRange:.1,min:0},legend:{enabled:true},plotOptions:{area:{fillColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,Highcharts.getOptions().colors[0]],[1,Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get("rgba")]]},marker:{radius:2},lineWidth:1,states:{hover:{lineWidth:1}},threshold:null}},series:[{type:"area",name:"Por día",pointInterval:24*3600*1e3,pointStart:Date.UTC(2013,10,1),data:e},{name:"Genero femenino",pointInterval:24*3600*1e3,pointStart:Date.UTC(2013,10,1),data:t.female},{name:"Genero masculino",pointInterval:24*3600*1e3,pointStart:Date.UTC(2013,10,1),data:t.male}]});$("#banner-slide").show();$("#points-graph").show()}function focusCity(e){if(e=="df"){dataGeoJson=DFGeoJson;printResults(dataGeoJson);map.setView([19.4313054168727,-99.1347885131836],12)}else if(e=="jalisco"){dataGeoJson=jaliscoGeoJson;printResults(dataGeoJson);map.setView([20.676073446781427,-103.34898948669434],12)}else if(e=="nl"){dataGeoJson=NLGeoJson;printResults(dataGeoJson);map.setView([25.677424366922754,-100.31719207763672],12)}}L.mapbox.accessToken="pk.eyJ1IjoiY2Fhcmxvc2h1Z28xIiwiYSI6IklmZGNsNmMifQ.JJksWU3hBP-Vd3S9WtjFsA";var map=L.mapbox.map("map","caarloshugo1.h9bggm26").setView([19.4313054168727,-99.1347885131836],11);var bounds=map.getBounds();var baseurl="http://bbva-api.appdata.mx";var data=false;var datazipcode=[];var sMarker=false;legend=L.control({position:"bottomright"});legend.onAdd=function(e){var t=L.DomUtil.create("div","info legend");t.innerHTML="<h5><strong>Series</strong></h5>";t.innerHTML+='<i style="background-color:#FFD4C4;">&nbsp;&nbsp;&nbsp;</i><small> <span class="serie1">0-0</span></small><br/>';t.innerHTML+='<i style="background-color:#FF8069;">&nbsp;&nbsp;&nbsp;</i><small> <span class="serie2">0-0</span></small><br/>';t.innerHTML+='<i style="background-color:#E84E3D;">&nbsp;&nbsp;&nbsp;</i><small> <span class="serie3">0-0</span></small><br/>';t.innerHTML+='<i style="background-color:#E63629;">&nbsp;&nbsp;&nbsp;</i><small> <span class="serie4">0-0</span></small><br/>';return t};legend.addTo(map);var dataGeoJson=DFGeoJson;var propertySelected="Sum_POB1";var polygonsGroup=new L.LayerGroup;var polygonsCustGroup=new L.LayerGroup;var polylinesGroup=new L.LayerGroup;var polylinesGroup2=new L.LayerGroup;var markersCustZC=new L.LayerGroup;var leftSidebar=L.control.sidebar("sidebar-left",{position:"left"});map.addControl(leftSidebar);var rightSidebar=L.control.sidebar("sidebar-right",{position:"right"});map.addControl(rightSidebar);rightSidebar.show();map.on("click",function(){leftSidebar.hide();rightSidebar.hide()});$(document).ready(function(){$(".loading").hide();$("#banner-slide").hide();Highcharts.setOptions({lang:{months:["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],weekdays:["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"]}});printResults(dataGeoJson);$("#banner-slide").bjqs({height:400,width:500,automatic:false});$("#graph-type").change(function(){if(sMarker){getSeries(datazipcode[sMarker.options.ZipCode])}else{}});$("#focus-city li a").click(function(){$(".selecciona-ciudad").toggleClass("showSC");$(".nav").toggleClass("showSC");$("#focus-city li").removeClass("active");$(this).parent().addClass("active");leftSidebar.hide();rightSidebar.hide();focusCity($(this).attr("id"))})})
